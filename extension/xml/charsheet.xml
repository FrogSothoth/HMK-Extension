<?xml version="1.0" encoding="iso-8859-1"?>
<root>
	<!--
		HarnMaster Character Sheet Definition
		Completely redefines the charsheet windowclass to use HarnMaster tabs
		(No merge attribute = full override)
	-->

	<windowclass name="charsheet">
		<frame>charsheet</frame>
		<sizelimits>
			<minimum width="650" height="600" />
			<dynamic />
		</sizelimits>
		<minimize>minimized_npc</minimize>
		<tooltip field="name" />
		<softclose />
		<script>
			local ATTRIBUTE_FIELDS = {
				"str_score", "end_score", "dex_score", "agl_score", "per_score", "cml_score",
				"aur_score", "wil_score", "rea_score", "cre_score", "emp_score", "elo_score", "voi_score"
			};

			function onInit()
				WindowTabManager.populate(self);

				-- Hook into tab selection to provide a refresh event for child windows
				if WindowTabManager.onTabSelect then
					local oldOnTabSelect = WindowTabManager.onTabSelect;
					WindowTabManager.onTabSelect = function(wTabControl, sTab)
						oldOnTabSelect(wTabControl, sTab);
						self.onTabSelect(sTab);
					end
				end

				local nodeChar = getDatabaseNode();
				if nodeChar then
					Debug.console("Registering attribute handlers for: " .. DB.getPath(nodeChar));
					for _, sField in ipairs(ATTRIBUTE_FIELDS) do
						local sPath = DB.getPath(nodeChar, sField);
						Debug.console("  Adding handler for: " .. sPath);
						DB.addHandler(sPath, "onUpdate", onAttributeChanged);
					end
					if SkillsManager and SkillsManager.recalculateAllSB then
						SkillsManager.recalculateAllSB(nodeChar);
					end
				else
					Debug.console("WARNING: No character node found in charsheet onInit");
				end
			end

			function onClose()
				local nodeChar = getDatabaseNode();
				if nodeChar then
					for _, sField in ipairs(ATTRIBUTE_FIELDS) do
						DB.removeHandler(DB.getPath(nodeChar, sField), "onUpdate", onAttributeChanged);
					end
				end
			end

			function onAttributeChanged(nodeField)
				Debug.console("onAttributeChanged fired for: " .. DB.getPath(nodeField));
				local nodeChar = DB.getParent(nodeField);
				if nodeChar then
					Debug.console("  Character node: " .. DB.getPath(nodeChar));
					if SkillsManager and SkillsManager.recalculateAllSB then
						Debug.console("  Calling recalculateAllSB");
						SkillsManager.recalculateAllSB(nodeChar);
					else
						Debug.console("  WARNING: SkillsManager.recalculateAllSB not available");
					end
				else
					Debug.console("  WARNING: Could not get parent node");
				end
			end

			function onTabSelect(sTab)
				Debug.console("charsheet.onTabSelect: " .. tostring(sTab));
				-- In many tab managers, the active subwindow is named after the tab, 
				-- or there is a generic 'content' subwindow.
				if self[sTab] and self[sTab].subwindow and self[sTab].subwindow.onRefresh then
					self[sTab].subwindow.onRefresh();
				elseif self.content and self.content.subwindow and self.content.subwindow.onRefresh then
					self.content.subwindow.onRefresh();
				end
			end
		</script>
		<sheetdata>
			<windowmenubar_charsheet name="menubar" />

			<anchor_content_charsheet_tabbed_top />
			<anchor_content_charsheet_bottom />

			<!-- Character name and portrait header -->
			<sub_content_top name="overview">
				<class>harn_charsheet_overview</class>
			</sub_content_top>

			<resize_charsheet />
		</sheetdata>

		<!-- Define our 5 HarnMaster tabs -->
		<tab>
			<name>main</name>
			<text>Main</text>
			<class>harn_tab_main</class>
		</tab>
		<tab merge="add">
			<name>attributes</name>
			<text>Attributes</text>
			<class>harn_tab_attributes</class>
		</tab>
		<tab merge="add">
			<name>skills</name>
			<text>Skills</text>
			<class>harn_tab_skills</class>
		</tab>
		<tab merge="add">
			<name>esoterica</name>
			<text>Esoterica</text>
			<class>harn_tab_esoterica</class>
		</tab>
		<tab merge="add">
			<name>combat</name>
			<text>Combat</text>
			<class>harn_tab_combat</class>
		</tab>
		<tab merge="add">
			<name>gear</name>
			<text>Gear</text>
			<class>harn_tab_gear</class>
		</tab>
	</windowclass>

	<!-- Character header/overview (name + portrait) -->
	<windowclass name="harn_charsheet_overview">
		<frame>groupbox</frame>
		<margins control="0,0,0,15" />
		<sheetdata>
			<anchor_content_charsheet_header_top />
			<anchor_content_charsheet_header_left />
			<anchor_content_charsheet_header_right />

			<!-- Portrait -->
			<picture_charsheet_v2 name="portrait" />

			<!-- Character Name -->
			<string_labeled name="name">
				<anchored to="rightanchor" height="30">
					<top offset="5" />
					<right relation="current" offset="-5" />
					<left parent="leftanchor" relation="current" offset="5" />
				</anchored>
				<labelres>harn_name</labelres>
				<font>charsheet_header</font>
			</string_labeled>
		</sheetdata>
	</windowclass>
</root>
